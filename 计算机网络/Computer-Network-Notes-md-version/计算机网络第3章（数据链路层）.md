# 3.1、数据链路层概述

## 概述

**链路**是从一个结点到相邻结点的一段物理线路，**数据链路**则是在链路的基础上增加了一些必要的硬件（如网络适配器）和软件（如协议的实现）

**网络中的主机、路由器等都必须实现数据链路层**

![image-20201011102531462](image/计算机网络第3章（数据链路层）.assets/image-20201011102531462.webp)

**局域网中的主机、交换机等都必须实现数据链路层**

![image-20201014004326549](image/计算机网络第3章（数据链路层）.assets/image-20201014004326549.webp)

**从层次上来看数据的流动**

![image-20201011102618878](image/计算机网络第3章（数据链路层）.assets/image-20201011102618878.webp)

**仅从数据链路层观察帧的流动**

![image-20201011102653161](image/计算机网络第3章（数据链路层）.assets/image-20201011102653161.webp)

![image-20201011102733584](image/计算机网络第3章（数据链路层）.assets/image-20201011102733584.webp)

![image-20230911083106227](image/计算机网络第3章（数据链路层）.assets/image-20230911083106227.webp)

![image-20230911083215547](image/计算机网络第3章（数据链路层）.assets/image-20230911083215547.webp)

> 主机H1 到主机H2 所经过的网络可以是多种不同类型的
>
> **注意：不同的链路层可能采用不同的数据链路层协议**

**数据链路层使用的信道**

数据链路层属于计算机网路的低层。**数据链路层使用的信道主要有以下两种类型：**

* 点对点信道
* 广播信道

![image-20201014004459744](image/计算机网络第3章（数据链路层）.assets/image-20201014004459744.webp)

> **局域网属于数据链路层**
>
> 局域网虽然是个网络。但我们并不把局域网放在网络层中讨论。这是因为在网络层要讨论的是多个网络互连的问题，是讨论分组怎么从一个网络，通过路由器，转发到另一个网络。
>
> 而在同一个局域网中，分组怎么从一台主机传送到另一台主机，但并不经过路由器转发。从整个互联网来看，**局域网仍属于数据链路层**的范围



## 三个重要问题

数据链路层传送的协议数据单元是**帧**

- **封装成帧**

  * **封装成帧** (framing) 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。

  * 首部和尾部的一个重要作用就是进行**帧定界**。


![image-20201011103650253](image/计算机网络第3章（数据链路层）.assets/image-20201011103650253.webp)

![image-20230911083734956](image/计算机网络第3章（数据链路层）.assets/image-20230911083734956.webp)

所以引出了透明传输

- **差错检测**

在传输过程中可能会产生**比特差错**：1 可能会变成 0， 而 0 也可能变成 1。

![image-20230911083918754](image/计算机网络第3章（数据链路层）.assets/image-20230911083918754.webp)

![image-20201011103917512](image/计算机网络第3章（数据链路层）.assets/image-20201011103917512.webp)

- **可靠传输**

  - 接收方主机收到有误码的帧后，是不会接受该帧的，会将它丢弃

    - 如果数据链路层向其上层提供的是不可靠服务，那么丢弃就丢弃了，不会再有更多措施


  - **如果数据链路层向其上层提供的是可靠服务，那就还需要其他措施，来确保接收方主机还可以重新收到被丢弃的这个帧的正确副本**

![image-20230911084041514](image/计算机网络第3章（数据链路层）.assets/image-20230911084041514.webp)

![image-20201011105314053](image/计算机网络第3章（数据链路层）.assets/image-20201011105314053.webp)

>以上三个问题都是使用**点对点信道的数据链路层**来举例的



**如果使用广播信道的数据链路层除了包含上面三个问题外，还有一些问题要解决**

如图所示，主机A，B，C，D，E通过一根总线进行互连，主机A要给主机C发送数据，代表帧的信号会通过总线传输到总线上的其他各主机，那么主机B，D，E如何知道所收到的帧不是发送给她们的，主机C如何知道发送的帧是发送给自己的

![image-20201011105824466](image/计算机网络第3章（数据链路层）.assets/image-20201011105824466.webp)

可以用编址（地址）的来解决

将帧的目的地址添加在帧中一起传输

![image-20201011110017415](image/计算机网络第3章（数据链路层）.assets/image-20201011110017415.webp)

还有数据碰撞问题

![image-20201011110129994](image/计算机网络第3章（数据链路层）.assets/image-20201011110129994.webp)

> 随着技术的发展，交换技术的成熟，
>
> 在 有线（局域网）领域 使用**点对点链路**和**链路层交换机**的**交换式局域网**取代了~~共享式局域网~~
>
> 在无线局域网中仍然使用的是共享信道技术



------



# 3.2、封装成帧

## 介绍

封装成帧是指数据链路层给上层交付的协议数据单元添加帧头和帧尾使之成为帧

* **帧头和帧尾中包含有重要的控制信息**

![image-20201011110851301](image/计算机网络第3章（数据链路层）.assets/image-20201011110851301.webp)



发送方的数据链路层将上层交付下来的协议数据单元封装成帧后，还要通过物理层，将构成帧的各比特，转换成电信号交给传输媒体，**那么接收方的数据链路层如何从物理层交付的比特流中提取出一个个的帧**？

答：需要帧头和帧尾来做**帧定界**

![image-20230911085126580](image/计算机网络第3章（数据链路层）.assets/image-20230911085126580.webp)



但**并不是每一种数据链路层协议的帧都包含有帧定界标志**，例如下面以太网帧的例子：

![image-20201011111729324](image/计算机网络第3章（数据链路层）.assets/image-20201011111729324.webp)

另外以太网还规定了**帧间间隔为96比特时间**，因此，**MAC帧不需要帧结束定界符**

![image-20230911085249539](image/计算机网络第3章（数据链路层）.assets/image-20230911085249539.webp)

> 前导码
>
> * 前同步码：作用是使接收方的时钟同步
> * 帧开始定界符：表明其后面紧跟着的就是MAC帧





## 透明传输

> **透明**
>
> 指某一个实际存在的事物看起来却好像不存在一样。

透明传输是指**数据链路层对上层交付的传输数据没有任何限制**，好像数据链路层不存在一样



**帧界定标志**也就是个特定数据值，如果在上层交付的协议数据单元中，**恰好也包含这个特定数值**，接收方就不能正确接收

![image-20201011113207944](image/计算机网络第3章（数据链路层）.assets/image-20201011113207944.webp)

> 所以数据链路层应该对上层交付的数据有限制，**其内容不能包含帧定界符的值**

**解决透明传输问题**

1. 面向字节的物理链路使用**字节填充（或称字符填充**）的方法实现透明传输。
2. 面向比特的物理链路使用**比特填充**的方法实现透明传输。

![image-20201011113804721](image/计算机网络第3章（数据链路层）.assets/image-20201011113804721.webp)

* **解决方法**：面向字节的物理链路使用**字节填充** (byte stuffing) 或**字符填充** (character stuffing)，面向比特的物理链路使用比特填充的方法实现透明传输
* 发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面**插入一个转义字符“ESC”**(其十六进制编码是1B)。
* 接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。
* 如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个。 

**但帧定界符并不是真的ESC字符，而是一串字节流**





若为面向比特：还可以采用**0比特填充法**：

- 这里是在5个连续的1后面填充一个比特0，和帧定界符加以区分

![image-20230911085824156](image/计算机网络第3章（数据链路层）.assets/image-20230911085824156.webp)

例题：

![image-20230911090241519](image/计算机网络第3章（数据链路层）.assets/image-20230911090241519.webp)

**帧的数据部分长度**

![image-20201011115008209](image/计算机网络第3章（数据链路层）.assets/image-20201011115008209.webp)



## 总结

![image-20201011115049672](image/计算机网络第3章（数据链路层）.assets/image-20201011115049672.webp)



------



# 3.3、差错检测

## 介绍

![image-20201011133757804](image/计算机网络第3章（数据链路层）.assets/image-20201011133757804.webp)



## 奇偶校验

![image-20201011234428217](image/计算机网络第3章（数据链路层）.assets/image-20201011234428217.webp)



## 循环冗余校验CRC(Cyclic Redundancy Check)

![image-20201011234605045](image/计算机网络第3章（数据链路层）.assets/image-20201011234605045.webp)

![image-20201011234701845](image/计算机网络第3章（数据链路层）.assets/image-20201011234701845.webp)

**例题**

![image-20201011235128869](image/计算机网络第3章（数据链路层）.assets/image-20201011235128869.webp)

![image-20201011235325022](image/计算机网络第3章（数据链路层）.assets/image-20201011235325022.webp)

**总结**

![image-20201011235726437](image/计算机网络第3章（数据链路层）.assets/image-20201011235726437.webp)

> 循环冗余校验 CRC 是一种检错方法，而帧校验序列 **FCS 是添加在数据后面的冗余码**



------



# 3.4、可靠传输(不仅局限于数据链路层)

## 3.4.1 可靠传输的基本概念

**下面是比特差错**

![image-20201012153605893](image/计算机网络第3章（数据链路层）.assets/image-20201012153605893.webp)

**其他传输差错**

![image-20201012153811724](image/计算机网络第3章（数据链路层）.assets/image-20201012153811724.webp)

* 分组丢失

路由器输入队列快满了，主动丢弃收到的分组

* 分组失序

数据并未按照发送顺序依次到达接收端

* 分组重复

由于某些原因，有些分组在网络中滞留了，没有及时到达接收端，这可能会造成发送端对该分组的重发，重发的分组到达接收端，但一段时间后，滞留在网络的分组也到达了接收端，这就造成**分组重复**的传输差错

![image-20201012160026362](image/计算机网络第3章（数据链路层）.assets/image-20201012160026362.webp)



**小结**

![image-20230911092423031](image/计算机网络第3章（数据链路层）.assets/image-20230911092423031.webp)

## 三种可靠协议

* 停止-等待协议SW
* 回退N帧协议GBN
* 选择重传协议SR

> 这三种可靠传输实现机制的基本原理并不仅限于数据链路层，可以应用到计算机网络体系结构的各层协议中



## 3.4.2 停止-等待协议SW

### 停止-等待协议遇到的四个问题发展与解决

**确认与否认**

<img src="image/计算机网络第3章（数据链路层）.assets/image-20201012162009780.webp" alt="image-20201012162009780" style="zoom:67%;" />

**超时重传**

<img src="image/计算机网络第3章（数据链路层）.assets/image-20201012162112151.webp" alt="image-20201012162112151" style="zoom:67%;" />

**确认丢失**

<img src="image/计算机网络第3章（数据链路层）.assets/image-20201012162318298.webp" alt="image-20201012162318298" style="zoom:67%;" />

<img src="image/计算机网络第3章（数据链路层）.assets/image-20201012162348428.webp" alt="image-20201012162348428" style="zoom:67%;" />

> 既然**数据分组**需要编号，**确认分组**是否需要编号？
>
> **要**。如下图所示

**确认迟到**

<img src="image/计算机网络第3章（数据链路层）.assets/image-20201012162815885.webp" alt="image-20201012162815885" style="zoom:67%;" />

> 注意，图中最下面那个数据分组与之前序号为0的那个数据分组不是同一个数据分组

**注意事项**

![image-20201012164008780](image/计算机网络第3章（数据链路层）.assets/image-20201012164008780.webp)



### 停止-等待协议的信道利用率

假设收发双方之间是一条直通的信道

* **TD**：是发送方发送数据分组所耗费的发送时延
* **RTT**：是收发双方之间的往返时间
* **TA**：是接收方发送确认分组所耗费的发送时延

TA一般都远小于TD，可以忽略，**当RTT远大于TD时，信道利用率会非常低**

![image-20230911093954662](image/计算机网络第3章（数据链路层）.assets/image-20230911093954662.webp)

> 像停止-等待协议这样通过确认和重传机制实现的可靠传输协议，常称为**自动请求重传协议ARQ**(**A**utomatic **R**epeat re**Q**uest)，意思是重传的请求是自动进行，因为不需要接收方显式地请求，发送方重传某个发送的分组

例题：

![image-20230911094224671](image/计算机网络第3章（数据链路层）.assets/image-20230911094224671.webp)



小结：

![image-20230911094933870](image/计算机网络第3章（数据链路层）.assets/image-20230911094933870.webp)

## 3.4.2 回退N帧协议GBN

### 为什么用回退N帧协议

在相同的时间内，使用停止-等待协议的发送方只能发送一个数据分组，而采用流水线传输的发送方，可以发送多个数据分组

![image-20201012190027828](image/计算机网络第3章（数据链路层）.assets/image-20201012190027828.webp)



回退N帧协议在流水线传输的基础上，利用发送窗口来限制发送方可连续发送数据分组的个数

![image-20201012190632086](image/计算机网络第3章（数据链路层）.assets/image-20201012190632086.webp)



### 无差错情况流程

发送方将序号落在发送窗口内的0~4号数据分组，依次连续发送出去

![image-20201012191936466](image/计算机网络第3章（数据链路层）.assets/image-20201012191936466.webp)



他们经过互联网传输正确到达接收方，就是没有乱序和误码，接收方按序接收它们，每接收一个，接收窗口就向前滑动一个位置，并给发送方发送针对所接收分组的确认分组，在通过互联网的传输正确到达了发送方

![image-20201012192932035](image/计算机网络第3章（数据链路层）.assets/image-20201012192932035.webp)

发送方每接收一个、发送窗口就向前滑动一个位置，这样就有新的序号落入发送窗口，发送方可以将收到确认的数据分组从缓存中删除了，而接收方可以择机将已接收的数据分组交付上层处理

![image-20201012193212419](image/计算机网络第3章（数据链路层）.assets/image-20201012193212419.webp)



### 累计确认

![image-20201012194304696](image/计算机网络第3章（数据链路层）.assets/image-20201012194304696.webp)

> 累计确认
>
> **优点:**
>
> * 即使确认分组丢失，发送方也可能不必重传
> * 减小接收方的开销
> * 减小对网络资源的占用
>
> **缺点：**
>
> * 不能向发送方及时反映出接收方已经正确接收的数据分组信息

### 有差错情况

例如

在传输数据分组时，5号数据分组出现误码，接收方通过数据分组中的检错码发现了错误

![image-20201012195440780](image/计算机网络第3章（数据链路层）.assets/image-20201012195440780.webp)

于是丢弃该分组，而后续到达的这剩下四个分组与接收窗口的序号不匹配

![image-20201012195629368](image/计算机网络第3章（数据链路层）.assets/image-20201012195629368.webp)

接收同样也不能接收它们，讲它们丢弃，并对之前按序接收的最后一个数据分组进行确认，发送ACK4，**每丢弃一个数据分组，就发送一个ACK4**

![image-20201012195836902](image/计算机网络第3章（数据链路层）.assets/image-20201012195836902.webp)

当收到重复的ACK4时，就知道之前所发送的数据分组出现了差错，于是可以不等超时计时器超时就立刻开始重传，具体收到几个重复确认就立刻重传，根据具体实现决定

![image-20201012200120166](image/计算机网络第3章（数据链路层）.assets/image-20201012200120166.webp)



如果收到这4个重复的确认并没有触发发送立刻重传，一段时间后。超时计时器超时，也会将发送窗口内以发送过的这些数据分组全部重传

![image-20201012200454557](image/计算机网络第3章（数据链路层）.assets/image-20201012200454557.webp)



### 窗口超值情况

**若WT超过取值范围，例如WT=8，会出现什么情况？**

![image-20201012201109774](image/计算机网络第3章（数据链路层）.assets/image-20201012201109774.webp)

> **无法分辨新旧分组**

习题

![image-20201012202419107](image/计算机网络第3章（数据链路层）.assets/image-20201012202419107.webp)

**总结**

![image-20201012202222138](image/计算机网络第3章（数据链路层）.assets/image-20201012202222138.webp)

* 回退N帧协议在流水线传输的基础上利用发送窗口来限制发送方连续发送数据分组的数量，**是一种连续ARQ协议**
* 在协议的工作过程中发送窗口和接收窗口不断向前滑动，因此这类协议又称为**滑动窗口协议**
* 由于回退N帧协议的特性，**当通信线路质量不好时，其信道利用率并不比停止-等待协议高**



## 3.4.3 选择重传协议SR

![image-20201012203638722](image/计算机网络第3章（数据链路层）.assets/image-20201012203638722.webp)

### 具体流程

![image-20230911102404325](image/计算机网络第3章（数据链路层）.assets/image-20230911102404325.webp)

![image-20230911102510033](image/计算机网络第3章（数据链路层）.assets/image-20230911102510033.webp)

![image-20230911103047775](image/计算机网络第3章（数据链路层）.assets/image-20230911103047775.webp)

> - 发送过程中2号数据丢失，所以接收方接收0 1 数据并向前滑动2个窗口，发送0 1 ACK，但是接收到3，没接收到2，所以发送3ACK但是不能滑动窗口；
> - 发送发接收到0 1 ACK窗口向前滑动两位，发送4 5数据，删除0 1 缓存，接受方将0 1交付上层处理
> - 发送方接收到3号ACK标记3已收到但未接收到2号ACK，所以窗口不能滑动，当超时重传后，接收方接收到2号数据，窗口才能往前滑动



### 窗口取值情况

![image-20201012204742870](image/计算机网络第3章（数据链路层）.assets/image-20201012204742870.webp)

> 若超出取值范围，**无法分辨新旧分组**
>
> 与回退N帧的区别：
>
> 回退N帧：1 < W~T~ < 2^n^-1
>
> 选择重传：1 < W~T~ < 2^(n-1)^



**习题**

![image-20201012205250996](image/计算机网络第3章（数据链路层）.assets/image-20201012205250996.webp)

**总结**



![image-20201012205133924](image/计算机网络第3章（数据链路层）.assets/image-20201012205133924.webp)



------



# 3.5、点对点协议PPP

* 点对点协议PPP（Point-to-Point Protocol）是目前使用最广泛的点对点数据链路层协议
* PPP协议是因特网工程任务组IEIF在1992年制定的。经过1993年和1994年的修订，现在的PPP协议已成为因特网的正式标准[RFC1661，RFC1662]
* 数据链路层使用的一种协议，它的特点是：简单；只检测差错，而不是纠正差错；不使用序号，也不进行流量控制；可同时支持多种网络层协议

![image-20201012210844629](image/计算机网络第3章（数据链路层）.assets/image-20201012210844629.webp)

* PPPoE 是为宽带上网的主机使用的链路层协议

![image-20201012211423528](image/计算机网络第3章（数据链路层）.assets/image-20201012211423528.webp)

## PPP帧格式

必须规定特殊的字符作为帧定界符

![image-20201012211826281](image/计算机网络第3章（数据链路层）.assets/image-20201012211826281.webp)

## 透明传输

 必须保证数据传输的透明性

实现透明传输的方法

* 面向字节的异步链路：字节填充法（插入“转义字符”）

![image-20201012212148803](image/计算机网络第3章（数据链路层）.assets/image-20201012212148803.webp)

* 面向比特的同步链路：比特填充法（插入“比特0”）

![image-20201012212255550](image/计算机网络第3章（数据链路层）.assets/image-20201012212255550.webp)

## 差错检测

能够对接收端收到的帧进行检测，并立即丢弃有差错的帧。

![image-20201012212558654](image/计算机网络第3章（数据链路层）.assets/image-20201012212558654.webp)

## 工作状态

* 当用户拨号接入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条**物理连接**。
* PC 机向路由器发送一系列的 LCP 分组（封装成多个 PPP 帧）。
* 这些分组及其响应选择一些 PPP 参数，并进行网络层配置，NCP 给新接入的 PC 机
* 分配一个临时的 IP 地址，使 PC 机成为因特网上的一个主机。
* 通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层的连接。

![image-20201012213021860](image/计算机网络第3章（数据链路层）.assets/image-20201012213021860.webp)

> 可见，PPP 协议已不是纯粹的数据链路层的协议，它还包含了物理层和网络层的内容。
>
> - PPP协议的**工作状态**有以下几种:链路**静止**状态(含起始状态和终止状态);链路**建立**状态;**鉴别**状态;**网络层协议**状态;链路**打开**状态; 链路**终止**状态。
>
> - 当用户要使用PPP协议和ISP建立连接进行通信时,需建立以下几种**连接**:
>
>   - (1)建立**物理层**的连接:用户PC机的通过调制解调器呼叫路由器在双方建立物理层的连接,以传输比特流。
>
>   - (2)建立**LCP**连接:这时双发要协商一些配置选项,包括链路上的最大帧长,鉴别协议的规约及不使用PPP帧中的地址和控制字段等,一旦协商成功,就建立了LCP链路,进入了鉴别状态。
>
>   - (3)建立**NCP**连接: 这时双方要进行NCP配置协商,根据网络层的不同协议互相交换网络层特定的网络控制分组。





# 3.6、共享式以太网

## 以太网类型

- 使用集线器的是**共享式以太网**
- 使用交换机的是**交换式以太网**



以太网目前已经从传统的共享式以太网发展到交换式以太网，传输速率已经从 10Mb/s提高到100Mb/s、1Gb/s甚至10Gb/s。

我们会首先介绍最早流行的传输速率为10Mb/s的共享式以太网的相关知识。



## 网络适配器（网卡）

要将计算机连接到以太网，需要使用相应的**网络适配器**(Adapter)，网络适配器一般简称为“**网卡**”。 

![image-20230920184723809](image/计算机网络第3章（数据链路层）.assets/image-20230920184723809.webp)

> EEPROM: 存储MAC地址和网卡的相关信息 
>
> BootROM: 插槽安装用于网络无盘工作站启动的BootROM芯片
>
> 核心芯片: 实现以太网的数据链路层和物理层功能
>
> 网络隔离变压器: 隔离核心芯片与RJ45网络接口，以便提高抗干扰能力并对核心芯片进行防雷击保护

在计算机内部，**网卡与CPU**之间的通信，一般是通过计算机主板上的I/O总线以**并行传输**方式进行。

**网卡与外部以太网**（局域网）之间的通信，一般是通过传输媒体（同轴电缆、双绞线电缆、光纤）以**串行方式**进行的。

网卡除要**实现物理层和数据链路层功能**，其另外一个重要功能就是要进行**并行传输和串行传输**的转换。由于网络的传输速率和计算机内部总线上的传输速率并不相同，因此在网卡的核心芯片中都会包含用于缓存数据的存储器。

在确保网卡硬件正确的情况下，为了使网卡正常工作，还必须要在计算机的操作系统中为网卡安装相应的设备驱动程序。**驱动程序**负责驱动网卡发送和接收帧。

## MAC地址

> * 使用点对点信道的数据链路层不需要使用地址
> * 使用广播信道的数据链路层必须使用地址来区分各主机

![image-20201014223659993](image/计算机网络第3章（数据链路层）.assets/image-20201014223659993.webp)

### 广播信道的数据链路层必须使用地址（MAC）

![image-20201014224732019](image/计算机网络第3章（数据链路层）.assets/image-20201014224732019.webp)

> **MAC地址又称为硬件地址或物理地址**。请注意：不要被 “物理” 二字误导认为物理地址属于物理层范畴，物理地址属于数据链路层范畴

![image-20230913210016287](image/计算机网络第3章（数据链路层）.assets/image-20230913210016287.webp)

### IEEE 802局域网的MAC地址格式

![image-20201014225358570](image/计算机网络第3章（数据链路层）.assets/image-20201014225358570.webp)

> **组织唯一标识符OUI**
>
> * 生产网络设备的厂商，需要向IEEE的注册管理机构申请一个或多个OUI
>
> **网络接口标识符**
>
> * 由获得OUI的厂商自行随意分配
>
> **EUI-48**
>
> * 48是这个MAC地址的位数

![image-20201014230248959](image/计算机网络第3章（数据链路层）.assets/image-20201014230248959.webp)

> 对于使用EUI-48空间的应用程序，IEEE的目标寿命为100年（直到2080年），但是鼓励采用EUI-64作为替代

**关于无效的 MAC 帧**

* 数据字段的长度与长度字段的值不一致；
* 帧的长度不是整数个字节；
* 用收到的帧检验序列 FCS 查出有差错；
* 数据字段的长度不在 46 ~ 1500 字节之间。
* 有效的 MAC 帧长度为 64 ~ 1518 字节之间。

> **对于检查出的无效** **MAC** **帧就简单地丢弃。以太网不负责重传丢弃的帧。** 



### IEEE 802局域网的MAC地址发送顺序

![image-20201014230625182](image/计算机网络第3章（数据链路层）.assets/image-20201014230625182.webp)



### 单播MAC地址举例

![image-20201014230822305](image/计算机网络第3章（数据链路层）.assets/image-20201014230822305.webp)

> 主机B给主机C发送**单播帧**，主机B首先要构建该**单播帧**，**在帧首部中的目的地址字段填入主机C的MAC地址**，源地址字段填入自己的MAC地址，再加上帧首部的其他字段、数据载荷以及帧尾部，就构成了该**单播帧**

![image-20201014231244655](image/计算机网络第3章（数据链路层）.assets/image-20201014231244655.webp)

> 主机B将该**单播帧**发送出去，主机A和C都会收到该**单播帧**
>
> 主机A的网卡发现该**单播帧**的目的MAC地址与自己的MAC地址不匹配，丢弃该帧
>
> 主机C的网卡发现该**单播帧**的目的MAC地址与自己的MAC地址匹配，接受该帧
>
> 并将该帧交给其上层处理



### 广播MAC地址举例

![image-20201014231754669](image/计算机网络第3章（数据链路层）.assets/image-20201014231754669.webp)

> 假设主机B要发送一个**广播帧**，主机B首先要构建该**广播帧**，**在帧首部中的目的地址字段填入广播地址**，也就是十六进制的全F，源地址字段填入自己的MAC地址，再加上帧首部中的其他字段、数据载荷以及帧尾部，就构成了该**广播帧**

![image-20201014232132424](image/计算机网络第3章（数据链路层）.assets/image-20201014232132424.webp)

> 主机B讲该**广播帧**发送出去，主机A和C都会收到该**广播帧**，**发现该帧首部中的目的地址字段的内容是广播地址**，就知道该帧是**广播帧**，主机A和主机C都接受该帧，并将该帧交给上层处理



### 多播MAC地址举例

![image-20201014232714791](image/计算机网络第3章（数据链路层）.assets/image-20201014232714791.webp)

> 假设主机A要发送**多播帧**给该**多播地址**。将该**多播地址**的左起第一个字节写成8个比特，第一个字节的最低比特位是1，这就表明该地址是**多播地址**。
>
> 快速判断地址是不是**多播地址**，就是上图所示箭头所指的**第十六进制数不能整除2（1,3,5,7,9,B,D,F）**，则该地址是**多播地址**
>
> 假设主机B，C和D支持多播，各用户给自己的主机配置多播组列表**如下所示**

![image-20201015001243584](image/计算机网络第3章（数据链路层）.assets/image-20201015001243584.webp)

> 主机B属于两个多播组，主机C也属于两个多播组，而主机D不属于任何多播组

![image-20201015001535528](image/计算机网络第3章（数据链路层）.assets/image-20201015001535528.webp)

> 主机A首先要构建该**多播帧**，**在帧首部中的目的地址字段填入该多播地址**，源地址点填入自己的MAC地址，再加上帧首部中的其他字段、数据载荷以及帧尾部，就构成了该**多播帧**

![image-20201015002054876](image/计算机网络第3章（数据链路层）.assets/image-20201015002054876.webp)

> 主机A将该**多播帧**发送出去，主机B、C、D都会收到该**多播帧**
>
> **主机B和C发现该多播帧的目的MAC地址在自己的多播组列表中**，主机B和C都会接受该帧
>
> 主机D发现该**多播帧**的目的MAC地址不在自己得多播组列表中，则丢弃该**多播帧**

> 给主机配置多播组列表进行私有应用时，不得使用公有的标准多播地址





------



## 媒体接入控制（介质访问控制）——广播信道

**媒体接入控制（介质访问控制）使用一对多的广播通信方式**

> **Medium Access Control**翻译成媒体接入控制，有些翻译成介质访问控制

**局域网的数据链路层**

* 局域网最主要的**特点**是：
  * 网络为一个单位所拥有；
  * 地理范围和站点数目均有限。 
* 局域网具有如下**主要优点**：
  * 具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源。 
  * 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变。
  * 提高了系统的可靠性、可用性和残存性。

![image-20201013201521915](image/计算机网络第3章（数据链路层）.assets/image-20201013201521915.webp)

![image-20201013201533445](image/计算机网络第3章（数据链路层）.assets/image-20201013201533445.webp)

**数据链路层的两个子层**

为了使数据链路层能更好地适应多种局域网标准，IEEE 802 委员会就将局域网的数据链路层拆成**两个子层**：

1. **逻辑链路控制** LLC (Logical Link Control)子层；
2. **媒体接入控制** MAC (Medium Access Control)子层。

与接入到传输媒体有关的内容都放在 MAC子层，而 LLC 子层则与传输媒体无关。
**不管采用何种协议的局域网，对 LLC 子层来说都是透明的。**

![image-20201013201133903](image/计算机网络第3章（数据链路层）.assets/image-20201013201133903.webp)





### 基本概念

为什么要媒体接入控制（介质访问控制）？

**共享信道带来的问题**

若多个设备在共享信道上同时发送数据，则会造成彼此干扰，导致发送失败。

![image-20201013152007335](image/计算机网络第3章（数据链路层）.assets/image-20201013152007335.webp)

![image-20201013152453425](image/计算机网络第3章（数据链路层）.assets/image-20201013152453425.webp)

> 随着技术的发展，交换技术的成熟和成本的降低，具有更高性能的使用点对点链路和链路层交换机的交换式局域网在有线领域已完全取代了共享式局域网，但由于无线信道的广播天性，无线局域网仍然使用的是共享媒体技术



### 静态划分信道

**信道复用**

![image-20201013153642544](image/计算机网络第3章（数据链路层）.assets/image-20201013153642544.webp)

**频分复用FDM (Frequency Division Multiplexing)**

* 将整个带宽分为多份，用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。

* **频分复用**的所有用户在同样的时间**占用不同的带宽资源**（请注意，这里的“带宽”是频率带宽而不是数据的发送速率）。

![image-20201013153947668](image/计算机网络第3章（数据链路层）.assets/image-20201013153947668.webp)

**时分复用TDM (Time Division Multiplexing)**

* **时分复用**则是将时间划分为一段段等长的**时分复用帧（TDM帧）**。每一个时分复用的用户在每一个 TDM 帧中占用固定序号的时隙。
* 每一个用户所占用的时隙是**周期性地出现**（其周期就是TDM帧的长度）的。
* TDM 信号也称为**等时** (isochronous) 信号。
* **时分复用的所有用户在不同的时间占用同样的频带宽度。**

![image-20201013154142540](image/计算机网络第3章（数据链路层）.assets/image-20201013154142540.webp)

**波分复用 WDM(Wavelength Division Multiplexing)**

![image-20201013202218132](image/计算机网络第3章（数据链路层）.assets/image-20201013202218132.webp)

> 波分复用就是光的频分复用，使用一根光纤来同时传输多个光载波信号
>
>  光信号传输一段距离后悔衰减，所以要用 掺铒光纤放大器 放大光信号

**码分复用 CDM  (Code Division Multiplexing)** 

![image-20201013203126625](image/计算机网络第3章（数据链路层）.assets/image-20201013203126625.webp)

![image-20201013203324709](image/计算机网络第3章（数据链路层）.assets/image-20201013203324709.webp)

![image-20201013203459640](image/计算机网络第3章（数据链路层）.assets/image-20201013203459640.webp)

![image-20201013203819578](image/计算机网络第3章（数据链路层）.assets/image-20201013203819578.webp)



### 动态接入控制

受控接入

**受控接入在局域网中使用得较少，本书不再讨论**



**随机接入**

**重点**



### 随机接入（CSMA/CD协议）

**总线局域网使用协议：CSMA/CD**

> 当使用**总线**型以太网或者使用**集线器**，会产生碰撞时，使用CSMA/CD协议
>
> 当使用**交换机**时，不用使用CSMA/CD协议

#### 基本概念

**最初**的**以太网**是将许多计算机都连接到一根总线上。易于实现广播通信。当初认为这样的连接方法既简单又可靠，因为总线上没有有源器件。

> **以太网（Ethernet）**是一种计算机**局域网技术**。IEEE组织的IEEE 802.3标准制定了**以太网（Ethernet）**的技术标准
>
> 以太网采用无连接的工作方式，对发送的数据帧不进行编号，也不要求对方发回确认。目的站收到有差错帧就把它丢弃，其他什么也不做

![image-20201013211620687](image/计算机网络第3章（数据链路层）.assets/image-20201013211620687.webp)

![image-20201013213102777](image/计算机网络第3章（数据链路层）.assets/image-20201013213102777.webp)



#### 多址接入MA

表示许多主机以多点接入的方式连接在一根总线上。

![image-20201013215400688](image/计算机网络第3章（数据链路层）.assets/image-20201013215400688.webp)



#### 载波监听CS

是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞。

![image-20201013215530979](image/计算机网络第3章（数据链路层）.assets/image-20201013215530979.webp)

总线上并没有什么“载波”。因此， **“载波监听”就是用电子技术检测总线上有没有其他计算机发送的数据信号。**



#### 碰撞检测CD

* **“碰撞检测”**就是计算机**边发送数据边检测**信道上的信号电压大小。
* 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。
* 当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。
* **所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称为“冲突检测”。**
* 在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。
* **每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。**

![image-20201013221240514](image/计算机网络第3章（数据链路层）.assets/image-20201013221240514.webp)

> 为什么要进行碰撞检测？ 因为信号传播时延对载波监听产生了影响
>
> ![image-20201013221834942](image/计算机网络第3章（数据链路层）.assets/image-20201013221834942.webp)
>
> A 需要单程传播时延的 2 倍的时间，才能检测到与 B 的发送产生了冲突

习题：

![image-20230913205934975](image/计算机网络第3章（数据链路层）.assets/image-20230913205934975.webp)

![image-20230913205942953](image/计算机网络第3章（数据链路层）.assets/image-20230913205942953.webp)



#### CSMA/CD 协议工作流程

![image-20201013221705893](image/计算机网络第3章（数据链路层）.assets/image-20201013221705893.webp)



#### CSMA/CD 协议工作——争用期（碰撞窗口）

![image-20201013223235305](image/计算机网络第3章（数据链路层）.assets/image-20201013223235305.webp)

> 端点主机A（先发送）检测到碰撞信号的时间为2τ(tau) - δ(delta)，**争用期2τ即为最长检测到碰撞的时间**
>
> 端点主机B（后发送）检测到碰撞信号的时间为τ

习题：

![image-20230913205753242](image/计算机网络第3章（数据链路层）.assets/image-20230913205753242.webp)

![image-20230913205801326](image/计算机网络第3章（数据链路层）.assets/image-20230913205801326.webp)

![image-20230913205813881](image/计算机网络第3章（数据链路层）.assets/image-20230913205813881.webp)



#### CSMA/CD 协议工作——最小帧长

![image-20201013224051932](image/计算机网络第3章（数据链路层）.assets/image-20201013224051932.webp)



#### CSMA/CD 协议工作——最大帧长

![image-20201013225400777](image/计算机网络第3章（数据链路层）.assets/image-20201013225400777.webp)



#### CSMA/CD 协议工作——截断二进制指数退避算法

![image-20201013230717856](image/计算机网络第3章（数据链路层）.assets/image-20201013230717856.webp)



#### CSMA/CD 协议工作——信道利用率

![image-20201013231430295](image/计算机网络第3章（数据链路层）.assets/image-20201013231430295.webp)



#### CSMA/CD 协议工作——帧接收流程

![image-20201013231703302](image/计算机网络第3章（数据链路层）.assets/image-20201013231703302.webp)



#### CSMA/CD 协议的重要特性

* 使用 CSMA/CD 协议的以太网不能进行全双工通信而**只能进行双向交替通信（半双工通信）。**
* 每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。 
* 这种**发送的不确定性**使整个以太网的平均通信量远小于以太网的最高数据率。 

> CSMA/CD协议曾经用于各种总线结构以太网和双绞线以太网的早起版本中。
>
> **现在的以太网基于交换机和全双工连接，不会有碰撞，因此没有必要使用CSMA/CS协议**



## 集线器-在物理层扩展以太网

### 概念

![image-20201015144628691](image/计算机网络第3章（数据链路层）.assets/image-20201015144628691.webp)

> * 传统以太网最初是使用粗同轴电缆，后来演进到使用比较便宜的细同轴电缆，最后发展为使用更便宜和更灵活的双绞线。
> * 采用双绞线的以太网采用星形拓扑，在星形的中心则增加了一种可靠性非常高的设备，叫做**集线器** (hub)。
> * **集线器**是也可以看做多口中继器，每个端口都可以成为一个中继器，中继器是对减弱的信号进行放大和发送的设备
> * **集线器**的以太网在逻辑上仍是个总线网，需要使用CSMA/CD协议来协调各主机争用总线，只能工作在半双工模式，收发帧不能同时进行



### 集线器HUB在物理层扩展以太网

**使用集线器扩展**：将多个以太网段连成更大的、多级星形结构的以太网

![image-20201015145732275](image/计算机网络第3章（数据链路层）.assets/image-20201015145732275.webp)

> * **优点**
>   1. 使原来属于不同碰撞域的以太网上的计算机能够进行跨碰撞域的通信。
>   2. 扩大了以太网覆盖的地理范围。
> * **缺点**
>   1. 碰撞域增大了，但总的吞吐量并未提高。
>   2. 如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互连起来。 

**碰撞域**

* **碰撞域（collision domain）**又称为**冲突域**，是指网络中一个站点发出的帧会与其他站点发出的帧产生碰撞或冲突的那部分网络。
* 碰撞域越大，发生碰撞的概率越高。



# 3.7、交换式以太网

## 概念

* 扩展以太网更常用的方法是在数据链路层进行。
* 早期使用**网桥**，现在使用**以太网交换机**。

![image-20201015150620067](image/计算机网络第3章（数据链路层）.assets/image-20201015150620067.webp)

> **网桥**
>
> * 网桥工作在数据链路层。
> * 它根据 MAC 帧的目的地址对收到的帧进行转发和过滤。
> * 当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的MAC 地址，然后再确定将该帧转发到哪一个接口，或把它丢弃。 
>
> **交换机**
>
> * 1990 年问世的交换式集线器 (switching hub) 可明显地提高以太网的性能。
> * 交换式集线器常称为**以太网交换机** (switch) 或**第二层交换机** (L2 switch)，强调这种交换机工作在数据链路层。
> * 以太网交换机实质上就是一个**多接口的网桥**



## 以太网交换机的生成树协议STP

### 如何提高以太网的可靠性

![image-20201015171453001](image/计算机网络第3章（数据链路层）.assets/image-20201015171453001.webp)

![image-20201015171515481](image/计算机网络第3章（数据链路层）.assets/image-20201015171515481.webp)

![image-20201015171900775](image/计算机网络第3章（数据链路层）.assets/image-20201015171900775.webp)



### 生成树协议STP

![image-20201015172204419](image/计算机网络第3章（数据链路层）.assets/image-20201015172204419.webp)

> * IEEE 802.1D 标准制定了一个**生成树协议 STP**  (Spanning Tree Protocol)。
> * 其**要点**是：**不改变**网络的实际拓扑，但在逻辑上则切断某些链路，使得从一台主机到所有其他主机的路径是**无环路的树状结构**，从而消除了兜圈子现象。

![image-20201015202257756](image/计算机网络第3章（数据链路层）.assets/image-20201015202257756.webp)



## 集线器HUB与交换机SWITCH区别

![image-20201015152232158](image/计算机网络第3章（数据链路层）.assets/image-20201015152232158.webp)

> 使用**集线器**互连而成的共享总线式以太网上的某个主机，要给另一个主机发送单播帧，该单播帧会通过共享总线传输到**总线上的其他各个主机**
>
> 使用交换机互连而成的交换式以太网上的某个主机，要给另一个主机发送单播帧，该单播帧进入交换机后，交换机会将该单播帧转发给目的主机，**而不是网络中的其他各个主机**
>
> **这个例子的前提条件是忽略ARP过程，并假设交换机的帧交换表已经学习或配置好了**



![image-20201015152858146](image/计算机网络第3章（数据链路层）.assets/image-20201015152858146.webp)

> **以太网交换机的交换方式**
>
> * 存储转发方式
>   * 把整个数据帧**先缓存**后再进行处理。
> * 直通 (cut-through) 方式
>   * 接收数据帧的同时就**立即按数据帧的目的 MAC 地址决定该帧的转发接口**，因而提高了帧的转发速度。
>   * **缺点**是它不检查差错就直接将帧转发出去，因此有可能也将一些无效帧转发给其他的站。
>
> **这个例子的前提条件是忽略ARP过程，并假设交换机的帧交换表已经学习或配置好了**



### 对比集线器和交换机

![image-20201015153907268](image/计算机网络第3章（数据链路层）.assets/image-20201015153907268.webp)

![image-20201015154523036](image/计算机网络第3章（数据链路层）.assets/image-20201015154523036.webp)

> 多台主机同时给另一台主机发送单播帧
>
> 集线器以太网：会产生碰撞，遭遇碰撞的帧会传播到总线上的各主机
>
> 交换机以太网：会将它们缓存起来，然后逐个转发给目的主机，不会产生碰撞
>
> **这个例子的前提条件是忽略ARP过程，并假设交换机的帧交换表已经学习或配置好了**



### 集线器扩展以太网和交换机扩展以太网区别

**单播**

![image-20201015155408692](image/计算机网络第3章（数据链路层）.assets/image-20201015155408692.webp)

**广播**

![image-20201015155440402](image/计算机网络第3章（数据链路层）.assets/image-20201015155440402.webp)

**多个单播**

![image-20201015155526386](image/计算机网络第3章（数据链路层）.assets/image-20201015155526386.webp)

![image-20201015155706698](image/计算机网络第3章（数据链路层）.assets/image-20201015155706698.webp)

广播域（broadcast domain）：指这样一部分网络，其中任何一台设备发出的广播通信都能被该部分网络中的所有其他设备所接收。

### 总结

![image-20201015160146482](image/计算机网络第3章（数据链路层）.assets/image-20201015160146482.webp)

![image-20201015160526999](image/计算机网络第3章（数据链路层）.assets/image-20201015160526999.webp)

> 工作在数据链路层的以太网交换机，其性能远远超过工作在物理层的集线器，而且价格并不贵，这就使得集线器逐渐被市场淘汰

## 以太网交换机自学习和转发帧的流程

### 概念

![image-20201015161015165](image/计算机网络第3章（数据链路层）.assets/image-20201015161015165.webp)

### 自学习和转发帧的例子

以下例子假设各主机知道网络中其他各主机的MAC地址（无需进行ARP）

**A -> B**

![image-20201015161458528](image/计算机网络第3章（数据链路层）.assets/image-20201015161458528.webp)

> 1. A 先向 B 发送一帧。该帧从接口 1 进入到交换机
> 2. 交换机收到帧后，先查找（图中左边）交换表。没有查到应从哪个接口转发这个帧给 B
> 3. 交换机把这个帧的源地址 A 和接口 1 写入（图中左边）交换表中
> 4. 交换机向除接口 1 以外的所有的接口广播这个帧
> 5. 接口 4到接口 2，先查找（图中右边）交换表。没有查到应从哪个接口转发这个帧给 B
> 6. 交换机把这个帧的源地址 A 和接口 1 写入（图中右边）交换表中
> 7. 除B主机之外与该帧的目的地址不相符，将丢弃该帧
> 8. 主机B发现是给自己的帧，接受该帧

**B -> A**

![image-20201015162310922](image/计算机网络第3章（数据链路层）.assets/image-20201015162310922.webp)

> 1. B 向 A 发送一帧。该帧从接口 3 进入到交换机
> 2. 交换机收到帧后，先查找（图中左边）交换表。发现（图中左边）交换表中的 MAC 地址有 A，表明要发送给A的帧应从接口1转发出去。于是就把这个帧传送到接口 1 转发给 A。
> 3. 主机 A 发现目的地址是它，就接受该帧
> 4. 交换机把这个帧的源地址 B 和接口 3 写入（图中左边）交换表中

**E -> A**

![image-20201015162622462](image/计算机网络第3章（数据链路层）.assets/image-20201015162622462.webp)

> 1. E 向 A发送一帧
> 2. 交换机收到帧后，先查找（图中右边）交换表。发现（图中右边）交换表中的 MAC 地址有 A，表明要发送给A的帧应从接口2转发出去。于是就把这个帧传送到接口 2 转发给 接口 4。
> 3. 交换机把这个帧的源地址 E 和接口 3 写入（图中右边）交换表中
> 4. 接口 4 到 左边的交换机，先查找（图中左边）交换表。发现（图中左边）交换表中的 MAC 地址有 A，表明要发送给A的帧应从接口1转发出去。于是就把这个帧传送到接口 1 转发给 A。
> 5. 交换机把这个帧的源地址 E 和接口 4 写入（图中左边）交换表中
> 6. 主机 A 发现目的地址是它，就接受该帧

**G -> A**

![image-20201015163157140](image/计算机网络第3章（数据链路层）.assets/image-20201015163157140.webp)

> 主机 A、主机 G、交换机 1的接口 1就共享同一条总线（相当于总线式网络，可以想象成用集线器连接了）
>
> 1. 主机 G 发送给 主机 A 一个帧
> 2. 主机 A 和 交换机接口 1都能接收到
> 3. 主机 A 的网卡收到后，根据帧的目的MAC地址A，就知道是发送给自己的帧，就接受该帧
> 4. 交换机 1收到该帧后，首先进行登记工作
> 5. 然后交换机 1对该帧进行转发，该帧的MAC地址是A，在（图中左边）交换表查找MAC 地址有 A
> 6. MAC 地址为 A的接口号是1，但是该帧正是从接口 1 进入交换机的，交换机不会再从该接口 1 将帧转发出去，因为这是没有必要，于是丢弃该帧

随着网络中各主机都发送了帧后，网络中的各交换机就可以学习到各主机的MAC地址，以及它们与自己各接口的对应关系

![image-20201015164210543](image/计算机网络第3章（数据链路层）.assets/image-20201015164210543.webp)

> 考虑到可能有时要在交换机的接口更换主机，或者主机要更换其网络适配器，这就需要更改交换表中的项目。为此，在交换表中每个项目都设有一定的**有效时间**。**过期的项目就自动被删除**。
>
> **以太网交换机的这种自学习方法使得以太网交换机能够即插即用，不必人工进行配置，因此非常方便。**



### 总结

**交换机自学习和转发帧的步骤归纳**

![image-20201015170656500](image/计算机网络第3章（数据链路层）.assets/image-20201015170656500.webp)

![image-20201015170739679](image/计算机网络第3章（数据链路层）.assets/image-20201015170739679.webp)



# 3.8、以太网V2MAC帧格式

以太网的 MAC 帧格式，分为：**DIX Ethernet V2（以太网版本 2 的帧格式）**和 **IEEE ８０２.３的帧格式**。这两种标准的 MAC 帧格式的差别很小，因此很多人并没有严格区分这两种标准，市场上流行 **DIX Ethernet V2（以太网版本 2 的帧格式）**因此，本节课只介绍以太网V２的 MAC 帧格式



如图所示，这是以太网 V２的 MAC 帧格式，以太网 V２的 MAC 帧，由目的地址，源地址，类型，数据载荷以及帧检验序列 FCS 这五个字段组成，目的地址和源地址字段分别为６字节长，用来填入帧的目的 

![image-20230920191615988](image/计算机网络第3章（数据链路层）.assets/image-20230920191615988.webp)

类型字段为２字节长，其值用来指明数据载荷字段中的内容是由上一层的哪个协议封装的，以便将收到的 MAC 帧的数据载荷字段中的内容上交给上一层的这个协议。

例如，当类型字段的值为０ｘ０８００时，则表明数据载荷字段的内容是 TCP／IP 网际层 IP协议封装的 IP 数据报，当类型字段的值为０ｘ８１３７时，则表明数据载荷字段中的内容是由 Novell 网际层 IPX 协议封装的协议数据单元，帧校验序列 FCS 字段的长度为４字节，它的内容是使用 CRC 生成的帧检验序列，接受方的网卡通过该字段的内容，就可检测出帧在传输过程中是否产生了误码，这是 CRC 检验的范围。

![image-20230920191708700](image/计算机网络第3章（数据链路层）.assets/image-20230920191708700.webp)

由于帧首部与帧尾部共有１８个字节，为满足以太网最小帧长为６４字节的规定，除去帧首部和尾部共１８字节，数据载荷字段的最小长度应为４６字节，当数据字段的长度小于４６字节时，数据链路层就会在数据载荷字段的后面插入相应数量的填充字节，以确保 **MAC 帧的长度不小于６４字节**，考虑到多种因素，例如：数据载荷的长度相较于帧首部和尾部的长度要尽量大

![image-20230920191734012](image/计算机网络第3章（数据链路层）.assets/image-20230920191734012.webp)

但对于差错处理，数据载荷的长度也不能太长，因此，数据载荷的最大长度被限制为１５００字节，显然，以太网 V２的 MAC 帧的**最大长度为１5１８字节**。



以太网 V２的数据链路层，将封装好的 MAC 帧交付给物理层进行发送，物理层在发送 MAC帧之前，还要在其前面添加８字节的前导码，前导码中的前７个字节为前同步码，作用是使接收方的时钟同步，之后的１字节为帧的开始符，表明其后面紧跟着的就是以太网帧

![image-20230920192151415](image/计算机网络第3章（数据链路层）.assets/image-20230920192151415.webp)



接收方可能收到的无效MAC帧包括以下几种： 

1. MAC帧的长度不是整数个字节通过
2. MAC帧的FCS字段的值检测出帧有误码 
3. MAC帧的长度不在64~1518字节之间



>接收方收到无效的MAC帧时，就简单将其**丢弃**以太网的数据链路层**没有重传机制**。



# 3.9、虚拟局域网VLAN

## 为什么要虚拟局域网VLAN

**广播风暴**

![image-20201015202859124](image/计算机网络第3章（数据链路层）.assets/image-20201015202859124.webp)

**分割广播域的方法**

![image-20201015203113654](image/计算机网络第3章（数据链路层）.assets/image-20201015203113654.webp)

> 为了分割广播域，所以虚拟局域网VLAN技术应运而生



## 概念

![image-20201015203559548](image/计算机网络第3章（数据链路层）.assets/image-20201015203559548.webp)

> * 利用以太网交换机可以很方便地实现虚拟局域网 VLAN (Virtual LAN)。
> * IEEE 802.1Q 对虚拟局域网 VLAN 的**定义**：
>   **虚拟局域网 VLAN** 是由一些局域网网段构成的**与物理位置无关的逻辑组**，而这些网段具有某些共同的需求。每一个 VLAN 的帧都有一个明确的标识符，指明发送这个帧的计算机是属于哪一个 VLAN。
> * 同一个VLAN内部可以广播通信，不同VLAN不可以广播通信
> * **虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网。**
> * 由于虚拟局域网是用户和网络资源的逻辑组合，因此可按照需要将有关设备和资源非常方便地重新组合，使用户从不同的服务器或数据库中存取所需的资源。



## 802.1Q帧格式

虚拟局域网VLAN技术是在交换机上实现的，需要交换机能够实现以下功能

* 能够处理带有VLAN标记的帧——IEEE 802.1 Q帧
* 交换机的各端口可以支持不同的端口类型，不同端口类型的端口对帧的处理方式有所不同

![image-20201015204639599](image/计算机网络第3章（数据链路层）.assets/image-20201015204639599.webp)

![image-20201015204749141](image/计算机网络第3章（数据链路层）.assets/image-20201015204749141.webp)

## 虚拟局域网VLAN的实现机制

**Access端口**

交换机与用户计算机之间的互连

![image-20201015205311757](image/计算机网络第3章（数据链路层）.assets/image-20201015205311757.webp)

> 同一个VLAN内部可以广播通信，不同VLAN不可以广播通信

**Truck端口**

交换机之间或交换机与路由器之间的互连

![image-20201015205947636](image/计算机网络第3章（数据链路层）.assets/image-20201015205947636.webp)



**小例题**

![image-20201015210417695](image/计算机网络第3章（数据链路层）.assets/image-20201015210417695.webp)



**华为交换机私有的Hybrid端口类型**

![image-20201015211031361](image/计算机网络第3章（数据链路层）.assets/image-20201015211031361.webp)

![image-20201015211349531](image/计算机网络第3章（数据链路层）.assets/image-20201015211349531.webp)



## 总结

![image-20201015211512622](image/计算机网络第3章（数据链路层）.assets/image-20201015211512622.webp)

> **虚拟局域网优点**
>
> 虚拟局域网（VLAN）技术具有以下主要优点：
>
> 1. 改善了性能
> 2. 简化了管理
> 3. 降低了成本
> 4. 改善了安全性 



# 3.10、以太网的发展

随着电子技术的发展，以太网已从最初的速率为 10Mb/s 的标准以太网，或称传统以太网，发展到每秒百兆比特 吉比特 10 吉比特 甚至是 100 吉比特的高速以太网，尽管速率达到100Mb/s 的以太网被称为高速以太网，但 100Mb/s 的速率，现在已经不能满足大多数用户对速率的需求，目前常用的速率为 1Gb/s 甚至更快。



**100BASE-T 以太网：**

![image-20230920190505465](image/计算机网络第3章（数据链路层）.assets/image-20230920190505465.webp)



**吉比特以太网：**

![image-20230920190544020](image/计算机网络第3章（数据链路层）.assets/image-20230920190544020.webp)

> 这是物理层为其添加的 8 字节前导码，对其进行载波延伸，使得 **MAC 帧的长度增大到 512字节**，这需要在帧尾部填充 **448** 字节的特殊字符。

![image-20230920190701333](image/计算机网络第3章（数据链路层）.assets/image-20230920190701333.webp)



**10吉比特以太网：**

![image-20230920190740418](image/计算机网络第3章（数据链路层）.assets/image-20230920190740418.webp)



**40/100 吉比特以太网：**

![image-20230920190820684](image/计算机网络第3章（数据链路层）.assets/image-20230920190820684.webp)





# 3.11 无线局域网的组成

## 802.11无线局域网的组成

![image-20230925150255355](image/计算机网络第3章（数据链路层）.assets/image-20230925150255355.webp)

我们来举例说明，如图所示：这是 802.11 无线局域网的有固定基础设施的组网方式，采用星型网络拓扑，位于其中心的基站被称为接入点，其英文缩写词为 AP，802.11 无线局域网的最小构件，称为基本服务集，其英文缩写词为 BSS，在一个 BSS 中，包含有一个 AP，和若干个移动站，本 BSS 内各站点之间的通信，以及与本 BSS 之外的站点之间的通信，都必须经过本 BSS 内的 AP 进行转发。

![image-20230925150354227](image/计算机网络第3章（数据链路层）.assets/image-20230925150354227.webp)

一个 BSS 可以是孤立的，也可以通过一个分配系统与其他 BSS 连接，这样就构成了一个扩展的服务集，分配系统的英文缩写词为 DS，扩展的服务集的英文缩写词为 ESS，DS 最常用的以太网，也可使用点对点链路或其他无线网络，ESS 还可为无线用户提供到其他非 802.11无线局域网的接入，例如通过 DS 有线连接到因特网，假设 BSS1 中的移动站 A，要给 BSS2中的移动站 B 发送数据，则必须经过 API DS AP2，最终将数据转发到移动站 B。

![image-20230925150449825](image/计算机网络第3章（数据链路层）.assets/image-20230925150449825.webp)

若移动站 A 从 BSS1 漫游到 BSS2，在漫游过程中移动站 A 的接入点从 BSS1 中的 AP1 改为了 BSS2 中的 AP2，但移动站 A 仍然可保持与移动站 B 的通信。

![image-20230925150607774](image/计算机网络第3章（数据链路层）.assets/image-20230925150607774.webp)



![image-20230925150654519](image/计算机网络第3章（数据链路层）.assets/image-20230925150654519.webp)

![image-20230925150755564](image/计算机网络第3章（数据链路层）.assets/image-20230925150755564.webp)

![image-20230925150812362](image/计算机网络第3章（数据链路层）.assets/image-20230925150812362.webp)



## 无线局域网的物理层

<img src="image/计算机网络第3章（数据链路层）.assets/image-20230925150938698.webp" alt="image-20230925150938698" style="zoom:150%;" />



## 无线局域网的数据链路层

**无线局域网的数据链路层——使用 `CSMA/CA` 协议（而不使用CSMA/CD 协议）** 

### CSMA/CA协议

**无线局域网使用的协议：CSMA/CA**

#### 为什么无线局域网要使用CSMA/CA协议

![image-20201014192811760](image/计算机网络第3章（数据链路层）.assets/image-20201014192811760.webp)

> 将碰撞检测（CD）改为了碰撞避免（CA）
>
> 原因：
>
> 1. 无线信号衰减度高
> 2. 存在隐蔽站问题
>
>  
>
> **隐蔽站问题：**
>
> ![image-20230925151511123](image/计算机网络第3章（数据链路层）.assets/image-20230925151511123.webp)
>
> 从信号覆盖范围可以看出，A 无法检测到 B 发送的信号，B 也无法检测到 A 发送的信号，假设 A 和 B 同时向接入点 AP 发送数据，这必然会产生碰撞，然而，根据无线信道的信号传播特点，碰撞信号的强度比较弱，即使分别传播到了 A 和 B，A 和 B 也无法检测到极度微弱的碰撞信号，这种问题就称为**隐蔽站**问题。
>
>  



#### 帧间间隔IFS（InterFrame Space）

![image-20201014200149717](image/计算机网络第3章（数据链路层）.assets/image-20201014200149717.webp)



#### CSMA/CA协议的工作原理

![image-20201014200833233](image/计算机网络第3章（数据链路层）.assets/image-20201014200833233.webp)

> **源站为什么在检测到信道空闲后还要再等待一段时间DIFS？**
>
> * 考虑到可能有其他的站有高优先级的帧要发送。若有，就要让高优先级帧先发送
>
> **目的站为什么正确接收数据帧后还要等待一段时间SIFS才能发送ACK帧？**
>
> * SIFS是最短的帧间间隔，用来分隔开属于一次对话的各帧，在这段时间内，一个站点应当能够从发送方式切换到接收方式

![image-20201014201511741](image/计算机网络第3章（数据链路层）.assets/image-20201014201511741.webp)

> 在 NAV（信道忙） 这段时间内，若其他站也有帧要发送，就必须推迟发送，在 NAV 这段时间结束后，再经过一个 DIFS 间隔，然后还要退避一段随机时间后，才能发送帧。
>
> **信道由忙转为空闲且经过DIFS时间后，还要退避一段随机时间才能使用信道？**
>
> 当某个站在发送领时，很可能有多个站都在监听信道并等待发送帧一旦信道空闲。这些站几乎同时发送顿而产生碰撞
>
> 为了避免上述情况，所有要发送帧的站检测到信道从忙转为空闲后都要执行退避算法，这样不仅可以**减少发生碰撞的概率**，还可**避免某个站长时间占用无线信道**

![image-20230925151820571](image/计算机网络第3章（数据链路层）.assets/image-20230925151820571.webp)

**使用退避算法的时机**

![image-20201014201927680](image/计算机网络第3章（数据链路层）.assets/image-20201014201927680.webp)



#### CSMA/CA协议的退避算法

![image-20201014202213766](image/计算机网络第3章（数据链路层）.assets/image-20201014202213766.webp)

**退避算法的示例**

eg1：

![image-20201014202819851](image/计算机网络第3章（数据链路层）.assets/image-20201014202819851.webp)

eg2：

![image-20230925152105099](image/计算机网络第3章（数据链路层）.assets/image-20230925152105099.webp)



#### CSMA/CA协议的信道预约和虚拟载波监听

![image-20201014203119710](image/计算机网络第3章（数据链路层）.assets/image-20201014203119710.webp)

![image-20201014203506878](image/计算机网络第3章（数据链路层）.assets/image-20201014203506878.webp)



**虚拟载波监听机制能减少隐蔽站带来的碰撞问题的示例**

如图所示：A 和 B 互为隐蔽站，A 给 AP 发送 RTS 帧进行信道预约，虽然 B 监听不到该帧，但却能监听到 AP 应答给 A 的 CTS 帧

![image-20230925152239551](image/计算机网络第3章（数据链路层）.assets/image-20230925152239551.webp)

B 根据 CTS 帧中的持续时间，修改自己的网络分配向量 NAV，在 NAV 只是的时间内，虽然B 监听不到 A 发送给 AP 的帧，但 B 也不会发送帧干扰 A 和 AP 的通信，接下来本题考查的就是我们刚刚才介绍过的 CSMA/CA 协议，通过交换 RTS 帧和 CTS 帧进行信道预约：

![image-20230925152343118](image/计算机网络第3章（数据链路层）.assets/image-20230925152343118.webp)



再看这道题，本题考查的是 DCF 帧间间隔 DIFS 与短帧间间隔 SIFS 的作用及各自的长度：

![image-20230925152401104](image/计算机网络第3章（数据链路层）.assets/image-20230925152401104.webp)

ifs1是长帧间间隔DIFS



## 无线局域网的 MAC 帧格式

802.11 无线局域网的 MAC 帧分为三种类型一种是**数据帧**，另一种是**控制帧**，还有一种是**管理帧**

![image-20230925152724330](image/计算机网络第3章（数据链路层）.assets/image-20230925152724330.webp)



### 帧头信息

帧控制信息：

![image-20230925161250966](image/计算机网络第3章（数据链路层）.assets/image-20230925161250966.webp)

![image-20230925152744720](image/计算机网络第3章（数据链路层）.assets/image-20230925152744720.webp)



### 帧格式类型

帧头中的**地址 1 到地址 4** 这四个字段的内容和使用情况，取决于帧控制字段中的，**去往 DS**和**来自 DS** 这两个**控制位**的值，如下表所示：最常用的是这两行所示的情况：

![image-20230925152937180](image/计算机网络第3章（数据链路层）.assets/image-20230925152937180.webp)



基本服务集 BSS1 中的站点 A 给 B 发送数据帧：

![image-20230925153025251](image/计算机网络第3章（数据链路层）.assets/image-20230925153025251.webp)

> A给B发：A -> AP1 -> B
>
> **去往DS和来自DS决定地址三的性质**
>
> A -> AP1：
>
> - 去往DS = 1：表示是自己发出去的帧
> - 地址1为下一站要发往的MAC地址
> - 地址2为该帧的上一站来源MAC地址，即为A本身
> - 地址3为最终目的地MAC地址（由去往DS决定）
>
> AP1 -> B：
>
> - 来自DS = 1：表示是发送给自己的帧
> - 地址1为下一站要发往的MAC地址，即B的地址
> - 地址2为该帧的上一站来源MAC地址，即为AP1
> - 地址3为初始发送地MAC地址（由来自DS决定）

![image-20230925160507513](image/计算机网络第3章（数据链路层）.assets/image-20230925160507513.webp)

![image-20230925160514703](image/计算机网络第3章（数据链路层）.assets/image-20230925160514703.webp)

> BSS要经过以太网连接：
>
> 地址1~4和上例一致
>
> 以太网数据帧使用以太网V2帧，以源地址和目的地址作为发送信息

![image-20230925161018200](image/计算机网络第3章（数据链路层）.assets/image-20230925161018200.webp)



